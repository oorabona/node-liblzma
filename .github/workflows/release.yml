name: Release

on:
  workflow_dispatch:
    inputs:
      increment:
        description: 'Semver increment (patch, minor, major)'
        type: choice
        required: true
        default: patch
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

env:
  NODE_VERSION: '22'

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    name: Create Release PR
    outputs:
      pr-number: ${{ steps.create-pr.outputs.pull-request-number }}
      new-version: ${{ steps.bump-version.outputs.new_version }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version and update CHANGELOG
        id: bump-version
        run: |
          # Dry-run to get the new version
          NEW_VERSION=$(pnpm release-it-preset default --dry-run --increment ${{ github.event.inputs.increment }} --ci 2>&1 | grep -oP "(?<=node-liblzma \().*(?=\.\.\.))" | tail -1 | cut -d'.' -f4-)

          # Actually bump version (without git push)
          pnpm release-it-preset default --no-git.push --ci --increment ${{ github.event.inputs.increment }}

          # Capture the new version from package.json
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=v${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "ðŸŽ¯ New version: v${NEW_VERSION}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/${{ steps.bump-version.outputs.new_version }}
          commit-message: "chore(release): ${{ steps.bump-version.outputs.new_version }}"
          title: "ðŸš€ Release ${{ steps.bump-version.outputs.new_version }}"
          body: |
            ## Release ${{ steps.bump-version.outputs.new_version }}

            This PR was automatically created by the release workflow.

            ### Changes
            - Version bump: `${{ steps.bump-version.outputs.new_version }}`
            - CHANGELOG updated

            ### Next steps
            Once this PR is merged, the build and publish workflow will automatically:
            1. Create the git tag `${{ steps.bump-version.outputs.new_version }}`
            2. Build native prebuilds for all platforms
            3. Publish to npm

            ---
            ðŸ¤– Generated by [Release Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: release,automated
          delete-branch: true

      - name: Enable Pull Request Automerge
        if: steps.create-pr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
          merge-method: squash

      - name: Summarize
        run: |
          echo "## ðŸŽ‰ Release PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.bump-version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR**: #${{ steps.create-pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Increment**: ${{ github.event.inputs.increment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pull request created with auto-merge enabled" >> $GITHUB_STEP_SUMMARY
          echo "â³ Once merged, build and publish will start automatically" >> $GITHUB_STEP_SUMMARY
