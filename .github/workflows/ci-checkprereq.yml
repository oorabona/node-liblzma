name: Check prerequisites

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
    # Map the workflow outputs to job outputs
    outputs:
      static-has-mt:
        description: "Does the static library exposes multithreading API ?"
        value: ${{ fromJSON(jobs.check.outputs.static-has-mt) }}
      shared-has-mt:
        description: "Does the shared library exposes multithreading API ?"
        value: ${{ fromJSON(jobs.check.outputs.shared-has-mt) }}

jobs:
  check:
    name: Checking if system library is multi threading capable
    runs-on: ${{ inputs.os }}
    # Map the job outputs to step outputs
    outputs:
      static-has-mt: ${{ steps.check-mt.outputs.STATIC }}
      shared-has-mt: ${{ steps.check-mt.outputs.SHARED }}
    steps:
      - name: Checking if system library is multi threading capable
        run: |
          if readelf -Wa /usr/lib/x86_64-linux-gnu/liblzma.a | grep lzma_stream_encoder_mt
          then
            echo "Static system library is multi threading capable: yes"
            echo '::set-output name=STATIC::true'
          else
            echo "Static system library is multi threading capable: no"
            echo '::set-output name=STATIC::false'
          fi
          if readelf -Wa /usr/lib/x86_64-linux-gnu/liblzma.so | grep lzma_stream_encoder_mt
          then
            echo "Dynamic system library is multi threading capable: yes"
            echo '::set-output name=SHARED::true'
          else
            echo "Dynamic system library is multi threading capable: no"
            echo '::set-output name=SHARED::false'
          fi
